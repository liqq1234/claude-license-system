<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络请求调试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .section h2 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>🔧 Claude 网络请求调试工具</h1>
    
    <div class="section">
        <h2>1. 环境检查</h2>
        <button onclick="checkEnvironment()">检查环境</button>
        <button onclick="checkLocalStorage()">检查本地存储</button>
        <div id="envLog" class="log"></div>
    </div>

    <div class="section">
        <h2>2. 激活码后端测试 (localhost:8888)</h2>
        <button onclick="testActivationBackend()">测试连接</button>
        <button onclick="testValidateAccess()">测试权限验证</button>
        <div id="activationLog" class="log"></div>
    </div>

    <div class="section">
        <h2>3. Pool后端测试 (localhost:3457)</h2>
        <button onclick="testPoolBackend()">测试连接</button>
        <button onclick="testPoolLogin()">测试登录接口</button>
        <div id="poolLog" class="log"></div>
    </div>

    <div class="section">
        <h2>4. 完整流程测试</h2>
        <div>
            <label>账户ID: <input type="text" id="accountId" value="1" /></label>
            <label>邮箱: <input type="text" id="accountEmail" value="test@example.com" /></label>
        </div>
        <button onclick="testFullFlow()">测试完整流程</button>
        <div id="fullFlowLog" class="log"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function checkEnvironment() {
            clearLog('envLog');
            log('envLog', '🔍 检查环境配置...', 'info');
            
            // 检查当前URL
            log('envLog', `当前页面: ${window.location.href}`, 'info');
            
            // 检查localStorage
            const token = localStorage.getItem('token');
            log('envLog', `Token存在: ${token ? '是' : '否'}`, token ? 'success' : 'error');
            
            if (token) {
                log('envLog', `Token长度: ${token.length}`, 'info');
                log('envLog', `Token前缀: ${token.substring(0, 20)}...`, 'info');
            }
        }

        async function checkLocalStorage() {
            clearLog('envLog');
            log('envLog', '🔍 检查本地存储...', 'info');
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                log('envLog', `${key}: ${value?.substring(0, 50)}${value?.length > 50 ? '...' : ''}`, 'info');
            }
        }

        async function testActivationBackend() {
            clearLog('activationLog');
            log('activationLog', '🔍 测试激活码后端连接...', 'info');
            
            try {
                const response = await fetch('http://localhost:8888/health');
                if (response.ok) {
                    const data = await response.text();
                    log('activationLog', '✅ 激活码后端连接成功', 'success');
                    log('activationLog', `响应: ${data}`, 'info');
                } else {
                    log('activationLog', `❌ 激活码后端响应错误: ${response.status}`, 'error');
                }
            } catch (error) {
                log('activationLog', `❌ 激活码后端连接失败: ${error.message}`, 'error');
            }
        }

        async function testValidateAccess() {
            clearLog('activationLog');
            log('activationLog', '🔍 测试权限验证...', 'info');
            
            const token = localStorage.getItem('token');
            if (!token) {
                log('activationLog', '❌ 没有找到token', 'error');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8888/api/claude/validate-access', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                log('activationLog', `响应状态: ${response.status}`, response.ok ? 'success' : 'error');
                log('activationLog', `响应数据: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (data.status === 0 && data.data?.hasAccess) {
                    log('activationLog', '✅ 权限验证成功', 'success');
                } else {
                    log('activationLog', '❌ 权限验证失败', 'error');
                }
            } catch (error) {
                log('activationLog', `❌ 权限验证请求失败: ${error.message}`, 'error');
            }
        }

        async function testPoolBackend() {
            clearLog('poolLog');
            log('poolLog', '🔍 测试Pool后端连接...', 'info');
            
            try {
                const response = await fetch('http://localhost:3457/health');
                if (response.ok) {
                    const data = await response.text();
                    log('poolLog', '✅ Pool后端连接成功', 'success');
                    log('poolLog', `响应: ${data}`, 'info');
                } else {
                    log('poolLog', `❌ Pool后端响应错误: ${response.status}`, 'error');
                }
            } catch (error) {
                log('poolLog', `❌ Pool后端连接失败: ${error.message}`, 'error');
            }
        }

        async function testPoolLogin() {
            clearLog('poolLog');
            log('poolLog', '🔍 测试Pool登录接口...', 'info');
            
            const token = localStorage.getItem('token');
            if (!token) {
                log('poolLog', '❌ 没有找到token', 'error');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:3457/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        mode: 'specific',
                        account_id: '1',
                        unique_name: `debug_${Date.now()}`,
                        expires_in: 3600
                    })
                });
                
                log('poolLog', `响应状态: ${response.status}`, response.ok ? 'success' : 'error');
                
                const data = await response.json();
                log('poolLog', `响应数据: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (response.ok) {
                    log('poolLog', '✅ Pool登录接口测试成功', 'success');
                    if (data.chat_url || data.login_url) {
                        log('poolLog', `🔗 获得URL: ${data.chat_url || data.login_url}`, 'success');
                    }
                } else {
                    log('poolLog', '❌ Pool登录接口测试失败', 'error');
                }
            } catch (error) {
                log('poolLog', `❌ Pool登录请求失败: ${error.message}`, 'error');
            }
        }

        async function testFullFlow() {
            clearLog('fullFlowLog');
            log('fullFlowLog', '🔍 开始完整流程测试...', 'info');
            
            const accountId = document.getElementById('accountId').value;
            const accountEmail = document.getElementById('accountEmail').value;
            
            log('fullFlowLog', `测试账户: ID=${accountId}, Email=${accountEmail}`, 'info');
            
            // 步骤1: 检查token
            const token = localStorage.getItem('token');
            if (!token) {
                log('fullFlowLog', '❌ 步骤1失败: 没有找到token', 'error');
                return;
            }
            log('fullFlowLog', '✅ 步骤1: Token检查通过', 'success');
            
            // 步骤2: 验证权限
            try {
                log('fullFlowLog', '🔄 步骤2: 验证用户权限...', 'info');
                const accessResponse = await fetch('http://localhost:8888/api/claude/validate-access', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const accessData = await accessResponse.json();
                log('fullFlowLog', `权限验证响应: ${JSON.stringify(accessData)}`, 'info');
                
                if (accessData.status !== 0 || !accessData.data?.hasAccess) {
                    log('fullFlowLog', '❌ 步骤2失败: 权限验证失败', 'error');
                    return;
                }
                log('fullFlowLog', '✅ 步骤2: 权限验证通过', 'success');
            } catch (error) {
                log('fullFlowLog', `❌ 步骤2失败: ${error.message}`, 'error');
                return;
            }
            
            // 步骤3: 调用Pool登录
            try {
                log('fullFlowLog', '🔄 步骤3: 调用Pool登录接口...', 'info');
                const loginResponse = await fetch('http://localhost:3457/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        mode: 'specific',
                        account_id: accountId,
                        unique_name: `debug_${Date.now()}`,
                        expires_in: 3600
                    })
                });
                
                log('fullFlowLog', `Pool登录响应状态: ${loginResponse.status}`, 'info');
                
                const loginData = await loginResponse.json();
                log('fullFlowLog', `Pool登录响应: ${JSON.stringify(loginData, null, 2)}`, 'info');
                
                if (!loginResponse.ok) {
                    log('fullFlowLog', `❌ 步骤3失败: ${loginData.error || 'Pool登录失败'}`, 'error');
                    return;
                }
                
                log('fullFlowLog', '✅ 步骤3: Pool登录成功', 'success');
                
                const targetUrl = loginData.chat_url || loginData.login_url;
                if (targetUrl) {
                    log('fullFlowLog', `🎉 完整流程测试成功! URL: ${targetUrl}`, 'success');
                    log('fullFlowLog', '点击下面的链接测试跳转:', 'info');
                    log('fullFlowLog', `<a href="${targetUrl}" target="_blank">${targetUrl}</a>`, 'info');
                } else {
                    log('fullFlowLog', '⚠️ 登录成功但没有获得URL', 'warning');
                }
                
            } catch (error) {
                log('fullFlowLog', `❌ 步骤3失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时自动检查环境
        window.onload = function() {
            checkEnvironment();
        };
    </script>
</body>
</html>
