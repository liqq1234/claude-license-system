<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç»œè¯·æ±‚è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .section h2 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Claude ç½‘ç»œè¯·æ±‚è°ƒè¯•å·¥å…·</h1>
    
    <div class="section">
        <h2>1. ç¯å¢ƒæ£€æŸ¥</h2>
        <button onclick="checkEnvironment()">æ£€æŸ¥ç¯å¢ƒ</button>
        <button onclick="checkLocalStorage()">æ£€æŸ¥æœ¬åœ°å­˜å‚¨</button>
        <div id="envLog" class="log"></div>
    </div>

    <div class="section">
        <h2>2. æ¿€æ´»ç åç«¯æµ‹è¯• (localhost:8888)</h2>
        <button onclick="testActivationBackend()">æµ‹è¯•è¿æ¥</button>
        <button onclick="testValidateAccess()">æµ‹è¯•æƒé™éªŒè¯</button>
        <div id="activationLog" class="log"></div>
    </div>

    <div class="section">
        <h2>3. Poolåç«¯æµ‹è¯• (localhost:3457)</h2>
        <button onclick="testPoolBackend()">æµ‹è¯•è¿æ¥</button>
        <button onclick="testPoolLogin()">æµ‹è¯•ç™»å½•æ¥å£</button>
        <div id="poolLog" class="log"></div>
    </div>

    <div class="section">
        <h2>4. å®Œæ•´æµç¨‹æµ‹è¯•</h2>
        <div>
            <label>è´¦æˆ·ID: <input type="text" id="accountId" value="1" /></label>
            <label>é‚®ç®±: <input type="text" id="accountEmail" value="test@example.com" /></label>
        </div>
        <button onclick="testFullFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
        <div id="fullFlowLog" class="log"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function checkEnvironment() {
            clearLog('envLog');
            log('envLog', 'ğŸ” æ£€æŸ¥ç¯å¢ƒé…ç½®...', 'info');
            
            // æ£€æŸ¥å½“å‰URL
            log('envLog', `å½“å‰é¡µé¢: ${window.location.href}`, 'info');
            
            // æ£€æŸ¥localStorage
            const token = localStorage.getItem('token');
            log('envLog', `Tokenå­˜åœ¨: ${token ? 'æ˜¯' : 'å¦'}`, token ? 'success' : 'error');
            
            if (token) {
                log('envLog', `Tokené•¿åº¦: ${token.length}`, 'info');
                log('envLog', `Tokenå‰ç¼€: ${token.substring(0, 20)}...`, 'info');
            }
        }

        async function checkLocalStorage() {
            clearLog('envLog');
            log('envLog', 'ğŸ” æ£€æŸ¥æœ¬åœ°å­˜å‚¨...', 'info');
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                log('envLog', `${key}: ${value?.substring(0, 50)}${value?.length > 50 ? '...' : ''}`, 'info');
            }
        }

        async function testActivationBackend() {
            clearLog('activationLog');
            log('activationLog', 'ğŸ” æµ‹è¯•æ¿€æ´»ç åç«¯è¿æ¥...', 'info');
            
            try {
                const response = await fetch('http://localhost:8888/health');
                if (response.ok) {
                    const data = await response.text();
                    log('activationLog', 'âœ… æ¿€æ´»ç åç«¯è¿æ¥æˆåŠŸ', 'success');
                    log('activationLog', `å“åº”: ${data}`, 'info');
                } else {
                    log('activationLog', `âŒ æ¿€æ´»ç åç«¯å“åº”é”™è¯¯: ${response.status}`, 'error');
                }
            } catch (error) {
                log('activationLog', `âŒ æ¿€æ´»ç åç«¯è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testValidateAccess() {
            clearLog('activationLog');
            log('activationLog', 'ğŸ” æµ‹è¯•æƒé™éªŒè¯...', 'info');
            
            const token = localStorage.getItem('token');
            if (!token) {
                log('activationLog', 'âŒ æ²¡æœ‰æ‰¾åˆ°token', 'error');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8888/api/claude/validate-access', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                log('activationLog', `å“åº”çŠ¶æ€: ${response.status}`, response.ok ? 'success' : 'error');
                log('activationLog', `å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (data.status === 0 && data.data?.hasAccess) {
                    log('activationLog', 'âœ… æƒé™éªŒè¯æˆåŠŸ', 'success');
                } else {
                    log('activationLog', 'âŒ æƒé™éªŒè¯å¤±è´¥', 'error');
                }
            } catch (error) {
                log('activationLog', `âŒ æƒé™éªŒè¯è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testPoolBackend() {
            clearLog('poolLog');
            log('poolLog', 'ğŸ” æµ‹è¯•Poolåç«¯è¿æ¥...', 'info');
            
            try {
                const response = await fetch('http://localhost:3457/health');
                if (response.ok) {
                    const data = await response.text();
                    log('poolLog', 'âœ… Poolåç«¯è¿æ¥æˆåŠŸ', 'success');
                    log('poolLog', `å“åº”: ${data}`, 'info');
                } else {
                    log('poolLog', `âŒ Poolåç«¯å“åº”é”™è¯¯: ${response.status}`, 'error');
                }
            } catch (error) {
                log('poolLog', `âŒ Poolåç«¯è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testPoolLogin() {
            clearLog('poolLog');
            log('poolLog', 'ğŸ” æµ‹è¯•Poolç™»å½•æ¥å£...', 'info');
            
            const token = localStorage.getItem('token');
            if (!token) {
                log('poolLog', 'âŒ æ²¡æœ‰æ‰¾åˆ°token', 'error');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:3457/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        mode: 'specific',
                        account_id: '1',
                        unique_name: `debug_${Date.now()}`,
                        expires_in: 3600
                    })
                });
                
                log('poolLog', `å“åº”çŠ¶æ€: ${response.status}`, response.ok ? 'success' : 'error');
                
                const data = await response.json();
                log('poolLog', `å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (response.ok) {
                    log('poolLog', 'âœ… Poolç™»å½•æ¥å£æµ‹è¯•æˆåŠŸ', 'success');
                    if (data.chat_url || data.login_url) {
                        log('poolLog', `ğŸ”— è·å¾—URL: ${data.chat_url || data.login_url}`, 'success');
                    }
                } else {
                    log('poolLog', 'âŒ Poolç™»å½•æ¥å£æµ‹è¯•å¤±è´¥', 'error');
                }
            } catch (error) {
                log('poolLog', `âŒ Poolç™»å½•è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testFullFlow() {
            clearLog('fullFlowLog');
            log('fullFlowLog', 'ğŸ” å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•...', 'info');
            
            const accountId = document.getElementById('accountId').value;
            const accountEmail = document.getElementById('accountEmail').value;
            
            log('fullFlowLog', `æµ‹è¯•è´¦æˆ·: ID=${accountId}, Email=${accountEmail}`, 'info');
            
            // æ­¥éª¤1: æ£€æŸ¥token
            const token = localStorage.getItem('token');
            if (!token) {
                log('fullFlowLog', 'âŒ æ­¥éª¤1å¤±è´¥: æ²¡æœ‰æ‰¾åˆ°token', 'error');
                return;
            }
            log('fullFlowLog', 'âœ… æ­¥éª¤1: Tokenæ£€æŸ¥é€šè¿‡', 'success');
            
            // æ­¥éª¤2: éªŒè¯æƒé™
            try {
                log('fullFlowLog', 'ğŸ”„ æ­¥éª¤2: éªŒè¯ç”¨æˆ·æƒé™...', 'info');
                const accessResponse = await fetch('http://localhost:8888/api/claude/validate-access', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const accessData = await accessResponse.json();
                log('fullFlowLog', `æƒé™éªŒè¯å“åº”: ${JSON.stringify(accessData)}`, 'info');
                
                if (accessData.status !== 0 || !accessData.data?.hasAccess) {
                    log('fullFlowLog', 'âŒ æ­¥éª¤2å¤±è´¥: æƒé™éªŒè¯å¤±è´¥', 'error');
                    return;
                }
                log('fullFlowLog', 'âœ… æ­¥éª¤2: æƒé™éªŒè¯é€šè¿‡', 'success');
            } catch (error) {
                log('fullFlowLog', `âŒ æ­¥éª¤2å¤±è´¥: ${error.message}`, 'error');
                return;
            }
            
            // æ­¥éª¤3: è°ƒç”¨Poolç™»å½•
            try {
                log('fullFlowLog', 'ğŸ”„ æ­¥éª¤3: è°ƒç”¨Poolç™»å½•æ¥å£...', 'info');
                const loginResponse = await fetch('http://localhost:3457/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        mode: 'specific',
                        account_id: accountId,
                        unique_name: `debug_${Date.now()}`,
                        expires_in: 3600
                    })
                });
                
                log('fullFlowLog', `Poolç™»å½•å“åº”çŠ¶æ€: ${loginResponse.status}`, 'info');
                
                const loginData = await loginResponse.json();
                log('fullFlowLog', `Poolç™»å½•å“åº”: ${JSON.stringify(loginData, null, 2)}`, 'info');
                
                if (!loginResponse.ok) {
                    log('fullFlowLog', `âŒ æ­¥éª¤3å¤±è´¥: ${loginData.error || 'Poolç™»å½•å¤±è´¥'}`, 'error');
                    return;
                }
                
                log('fullFlowLog', 'âœ… æ­¥éª¤3: Poolç™»å½•æˆåŠŸ', 'success');
                
                const targetUrl = loginData.chat_url || loginData.login_url;
                if (targetUrl) {
                    log('fullFlowLog', `ğŸ‰ å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸ! URL: ${targetUrl}`, 'success');
                    log('fullFlowLog', 'ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥æµ‹è¯•è·³è½¬:', 'info');
                    log('fullFlowLog', `<a href="${targetUrl}" target="_blank">${targetUrl}</a>`, 'info');
                } else {
                    log('fullFlowLog', 'âš ï¸ ç™»å½•æˆåŠŸä½†æ²¡æœ‰è·å¾—URL', 'warning');
                }
                
            } catch (error) {
                log('fullFlowLog', `âŒ æ­¥éª¤3å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç¯å¢ƒ
        window.onload = function() {
            checkEnvironment();
        };
    </script>
</body>
</html>
