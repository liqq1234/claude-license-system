<template>
    <div class="account-management">
        <!-- Ê∑ªÂä†Áî®Êà∑Âå∫Âüü -->
        <div class="add-user-section">
            <el-card>
                <template #header>
                    <div class="card-header">
                        <span>‚ûï Ê∑ªÂä†Êñ∞Áî®Êà∑</span>
                    </div>
                </template>

                <div class="add-user-form">
                    <el-row :gutter="20">
                        <el-col :span="8">
                            <el-input
                                v-model="newUser.email"
                                placeholder="new-user@example.com"
                                size="large"
                                :disabled="addLoading"
                            >
                                <template #prepend>üìß ÈÇÆÁÆ±</template>
                            </el-input>
                        </el-col>
                        <el-col :span="12">
                            <el-input
                                v-model="newUser.sessionKey"
                                placeholder="sk-ant-session-..."
                                size="large"
                                :disabled="addLoading"
                            >
                                <template #prepend>üîë Session Key</template>
                            </el-input>
                        </el-col>
                        <el-col :span="4">
                            <el-button
                                type="primary"
                                size="large"
                                :loading="addLoading"
                                @click="addUser"
                                :disabled="!newUser.email || !newUser.sessionKey"
                                class="add-button"
                            >{{ addLoading ? 'Ê∑ªÂä†‰∏≠...' : 'Ê∑ªÂä†Áî®Êà∑' }}</el-button>
                        </el-col>
                    </el-row>
                </div>
            </el-card>
        </div>

        <!-- ÊêúÁ¥¢ÂíåÊìç‰ΩúÊ†è -->
        <div class="search-section">
            <el-card>
                <div class="search-bar">
                    <el-input
                        v-model="searchQuery"
                        placeholder="ÊåâÈÇÆÁÆ±ÊêúÁ¥¢..."
                        size="large"
                        clearable
                        class="search-input"
                    >
                        <template #prefix>üîç</template>
                    </el-input>

                    <div class="view-mode-switch">
                        <el-radio-group v-model="viewMode" size="large">
                            <el-radio-button value="table">üìã Ë°®Ê†ºËßÜÂõæ</el-radio-button>
                            <el-radio-button value="cards">üéØ Áä∂ÊÄÅÂç°Áâá</el-radio-button>
                        </el-radio-group>
                    </div>

                    <div class="action-buttons">
                        <el-button @click="selectAll" size="large" v-if="viewMode === 'table'">ÂÖ®ÈÄâ</el-button>
                        <el-button @click="selectNone" size="large" v-if="viewMode === 'table'">ÂèçÈÄâ</el-button>
                        <el-button
                            type="danger"
                            @click="deleteSelected"
                            :disabled="selectedAccounts.length === 0"
                            size="large"
                            v-if="viewMode === 'table'"
                        >Âà†Èô§ÈÄâ‰∏≠ ({{ selectedAccounts.length }})</el-button>
                        <el-button @click="refreshAccounts" size="large">üîÑ Âà∑Êñ∞</el-button>
                    </div>
                </div>
            </el-card>
        </div>

        <!-- Ë¥¶Êà∑ÂàóË°® -->
        <div class="account-list-section">
            <el-card>
                <template #header>
                    <div class="card-header">
                        <span>üë• Áî®Êà∑Ë¥¶Êà∑ÂàóË°® ({{ filteredAccounts.length }})</span>
                        <span
                            class="view-mode-indicator"
                        >{{ viewMode === 'table' ? 'Ë°®Ê†ºËßÜÂõæ' : 'Áä∂ÊÄÅÂç°ÁâáËßÜÂõæ' }}</span>
                    </div>
                </template>

                <!-- Âä†ËΩΩ‰∏≠ÊèêÁ§∫ -->
                <div v-if="loading" class="loading-message">
                    <el-skeleton :rows="5" animated />
                </div>

                <!-- Áä∂ÊÄÅÂç°ÁâáËßÜÂõæ -->
                <div
                    v-else-if="viewMode === 'cards' && filteredAccounts.length > 0"
                    class="cards-view"
                >
                    <div class="account-cards-grid">
                        <div
                            v-for="account in filteredAccounts"
                            :key="account.email"
                            class="account-card"
                            @click="handleAccountLogin(account)"
                        >
                            <div class="card-header">
                                <h3>{{ account.unique_name || account.email }}</h3>
                                <span class="status-badge status-idle">Á©∫Èó≤</span>
                            </div>
                            <div class="card-body">
                                <p>
                                    <strong>ÈÇÆÁÆ±:</strong>
                                    {{ account.email }}
                                </p>
                                <p>
                                    <strong>ÂàõÂª∫Êó∂Èó¥:</strong>
                                    {{ formatDate(account.created_at) }}
                                </p>
                                <p>
                                    <strong>‰ΩøÁî®Ê¨°Êï∞:</strong>
                                    {{ account.usage_count || 0 }}
                                </p>
                            </div>
                            <div class="card-actions">
                                <el-button
                                    type="primary"
                                    size="small"
                                    @click.stop="handleAccountLogin(account)"
                                >ÁôªÂΩï‰ΩøÁî®</el-button>
                                <el-button
                                    type="danger"
                                    size="small"
                                    @click.stop="handleDeleteAccount(account)"
                                >Âà†Èô§</el-button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ë¥¶Êà∑Ë°®Ê†º -->
                <div
                    v-else-if="viewMode === 'table' && filteredAccounts.length > 0"
                    class="account-table"
                >
                    <el-table
                        :data="filteredAccounts"
                        style="width: 100%"
                        @selection-change="handleSelectionChange"
                    >
                        <el-table-column type="selection" width="55" />

                        <el-table-column prop="email" label="ÈÇÆÁÆ±Âú∞ÂùÄ" min-width="200">
                            <template #default="{ row }">
                                <el-input
                                    v-if="editingAccount === row.email"
                                    v-model="editForm.email"
                                    size="small"
                                />
                                <span v-else class="email-text">{{ row.email }}</span>
                            </template>
                        </el-table-column>

                        <el-table-column prop="sk_preview" label="Session Key" min-width="300">
                            <template #default="{ row }">
                                <el-input
                                    v-if="editingAccount === row.email"
                                    v-model="editForm.sessionKey"
                                    size="small"
                                    type="password"
                                    show-password
                                    placeholder="ËæìÂÖ•ÂÆåÊï¥ÁöÑ Session Key (sk-ant-...)"
                                />
                                <span v-else class="sk-preview">{{ row.sk_preview }}</span>
                            </template>
                        </el-table-column>

                        <el-table-column label="Êìç‰Ωú" width="150">
                            <template #default="{ row }">
                                <div class="action-buttons-cell">
                                    <template v-if="editingAccount === row.email">
                                        <el-button
                                            type="success"
                                            size="small"
                                            @click="saveEdit(row.email)"
                                            :loading="editLoading"
                                        >‰øùÂ≠ò</el-button>
                                        <el-button size="small" @click="cancelEdit">ÂèñÊ∂à</el-button>
                                    </template>
                                    <template v-else>
                                        <el-button
                                            type="primary"
                                            size="small"
                                            @click="startEdit(row)"
                                        >ÁºñËæë</el-button>
                                        <el-button
                                            type="danger"
                                            size="small"
                                            @click="deleteAccount(row.email)"
                                        >Âà†Èô§</el-button>
                                    </template>
                                </div>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>

                <!-- Á©∫Áä∂ÊÄÅ -->
                <div v-else class="empty-state">
                    <el-empty description="ÊöÇÊó†Ë¥¶Êà∑Êï∞ÊçÆ">
                        <el-button type="primary" @click="refreshAccounts">Âà∑Êñ∞Êï∞ÊçÆ</el-button>
                    </el-empty>
                </div>
            </el-card>
        </div>
    </div>
</template>

<script setup>
import { ref, computed, watch, onMounted } from "vue";
import { ElMessage, ElMessageBox } from "element-plus";
import { claudePoolApi } from "@/api/claude-pool";

// Props
const props = defineProps({
    accountList: {
        type: Array,
        default: () => [],
    },
});

// Emits
const emit = defineEmits(["refresh"]);

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const loading = ref(false);
const addLoading = ref(false);
const editLoading = ref(false);
const searchQuery = ref("");
const selectedAccounts = ref([]);
const editingAccount = ref(null);
const viewMode = ref("table"); // 'table' Êàñ 'cards'

// Êñ∞Áî®Êà∑Ë°®Âçï
const newUser = ref({
    email: "",
    sessionKey: "",
});

// ÁºñËæëË°®Âçï
const editForm = ref({
    email: "",
    sessionKey: "",
});

// ËÆ°ÁÆóÂ±ûÊÄß
const filteredAccounts = computed(() => {
    if (!props.accountList || props.accountList.length === 0) {
        return [];
    }

    // Â§ÑÁêÜË¥¶Êà∑Êï∞ÊçÆÔºåÊ∑ªÂä† sk_preview Â≠óÊÆµ
    const processedAccounts = props.accountList.map((account) => ({
        ...account,
        sk_preview: account.sessionKey
            ? `${account.sessionKey.substring(0, 20)}...`
            : account.sk
            ? `${account.sk.substring(0, 20)}...`
            : account.sk_preview || "N/A",
    }));

    if (!searchQuery.value) {
        return processedAccounts;
    }

    return processedAccounts.filter((account) =>
        account.email.toLowerCase().includes(searchQuery.value.toLowerCase())
    );
});

const accountsStatus = ref(new Map());

// Â∏¶Áä∂ÊÄÅÁöÑË¥¶Êà∑ÂàóË°®
const accountsWithStatus = computed(() => {
    return filteredAccounts.value.map((account) => {
        const status = accountsStatus.value.get(account.email) || {
            status: "idle",
            status_text: "Á©∫Èó≤",
            color: "green",
            countdown: "",
            remaining_seconds: 0,
        };
        return {
            ...account,
            ...status,
        };
    });
});

// ÊñπÊ≥ï
const toggleSelection = (email) => {
    const index = selectedAccounts.value.indexOf(email);
    if (index > -1) {
        selectedAccounts.value.splice(index, 1);
    } else {
        selectedAccounts.value.push(email);
    }
};

const selectAll = () => {
    selectedAccounts.value = filteredAccounts.value.map(
        (account) => account.email
    );
};

const selectNone = () => {
    selectedAccounts.value = [];
};

const deleteAccount = async (email) => {
    try {
        await ElMessageBox.confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ë¥¶Êà∑ ${email} ÂêóÔºü`, "Á°ÆËÆ§Âà†Èô§", {
            confirmButtonText: "Á°ÆÂÆö",
            cancelButtonText: "ÂèñÊ∂à",
            type: "warning",
        });

        loading.value = true;
        await claudePoolApi.deleteAccount(email);
        ElMessage.success("Ë¥¶Êà∑Âà†Èô§ÊàêÂäü");
        emit("refresh");
    } catch (error) {
        if (error !== "cancel") {
            console.error("Âà†Èô§Ë¥¶Êà∑Â§±Ë¥•:", error);
            ElMessage.error("Âà†Èô§Ë¥¶Êà∑Â§±Ë¥•");
        }
    } finally {
        loading.value = false;
    }
};

const deleteSelected = async () => {
    if (selectedAccounts.value.length === 0) return;

    try {
        await ElMessageBox.confirm(
            `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedAccounts.value.length} ‰∏™Ë¥¶Êà∑ÂêóÔºü`,
            "ÊâπÈáèÂà†Èô§Á°ÆËÆ§",
            {
                confirmButtonText: "Á°ÆÂÆö",
                cancelButtonText: "ÂèñÊ∂à",
                type: "warning",
            }
        );

        loading.value = true;
        // ÊâπÈáèÂà†Èô§Ë¥¶Êà∑
        for (const email of selectedAccounts.value) {
            await claudePoolApi.deleteAccount(email);
        }
        ElMessage.success(`ÊàêÂäüÂà†Èô§ ${selectedAccounts.value.length} ‰∏™Ë¥¶Êà∑`);
        selectedAccounts.value = [];
        emit("refresh");
    } catch (error) {
        if (error !== "cancel") {
            console.error("ÊâπÈáèÂà†Èô§Ë¥¶Êà∑Â§±Ë¥•:", error);
            ElMessage.error("ÊâπÈáèÂà†Èô§Ë¥¶Êà∑Â§±Ë¥•");
        }
    } finally {
        loading.value = false;
    }
};

// Ê∑ªÂä†Áî®Êà∑
const addUser = async () => {
    if (!newUser.value.email || !newUser.value.sessionKey) {
        ElMessage.warning("ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÈÇÆÁÆ±ÂíåSession Key");
        return;
    }

    try {
        addLoading.value = true;
        await claudePoolApi.addAccount(
            newUser.value.email,
            newUser.value.sessionKey
        );
        ElMessage.success("Áî®Êà∑Ê∑ªÂä†ÊàêÂäü");

        // Ê∏ÖÁ©∫Ë°®Âçï
        newUser.value.email = "";
        newUser.value.sessionKey = "";

        emit("refresh");
    } catch (error) {
        console.error("Ê∑ªÂä†Áî®Êà∑Â§±Ë¥•:", error);
        ElMessage.error("Ê∑ªÂä†Áî®Êà∑Â§±Ë¥•");
    } finally {
        addLoading.value = false;
    }
};

// Âà∑Êñ∞Ë¥¶Êà∑ÂàóË°®
const refreshAccounts = () => {
    emit("refresh");
};

// Âà∑Êñ∞ÊâÄÊúâË¥¶Êà∑Áä∂ÊÄÅ
const refreshAllStatus = async () => {
    statusLoading.value = true;
    try {
        const statusList = await claudePoolApi.getAllAccountsStatus();

        // Êõ¥Êñ∞Áä∂ÊÄÅÊò†Â∞Ñ
        accountsStatus.value.clear();
        statusList.forEach((status) => {
            accountsStatus.value.set(status.email, status);
        });

        ElMessage.success("Áä∂ÊÄÅÂà∑Êñ∞ÊàêÂäü");
    } catch (error) {
        console.error("Âà∑Êñ∞Áä∂ÊÄÅÂ§±Ë¥•:", error);
        ElMessage.error("Âà∑Êñ∞Áä∂ÊÄÅÂ§±Ë¥•");
    } finally {
        statusLoading.value = false;
    }
};

// Â§ÑÁêÜË¥¶Êà∑ÁôªÂΩï
const handleAccountLogin = async (account) => {
    try {
        // ËøôÈáåÂèØ‰ª•Ë∞ÉÁî®ÂÆûÈôÖÁöÑÁôªÂΩïÈÄªËæë
        // ‰æãÂ¶ÇË∞ÉÁî®Âø´ÈÄüÁôªÂΩïAPI
        await claudePoolApi.adminSpecificLogin(
            account.email,
            account.unique_name || account.email.split("@")[0]
        );

        ElMessage.success(`Ê≠£Âú®‰∏∫ÊÇ®ÁôªÂΩï ${account.email}`);
    } catch (error) {
        console.error("ÁôªÂΩïÂ§±Ë¥•:", error);
        ElMessage.error(
            "ÁôªÂΩïÂ§±Ë¥•: " + (error.response?.data?.error || error.message)
        );
    }
};

// Â§ÑÁêÜÁä∂ÊÄÅÊõ¥Êñ∞
const handleStatusUpdated = (status) => {
    accountsStatus.value.set(status.email, status);
};

// Â§ÑÁêÜË°®Ê†ºÈÄâÊã©ÂèòÂåñ
const handleSelectionChange = (selection) => {
    selectedAccounts.value = selection.map((item) => item.email);
};

// ÂºÄÂßãÁºñËæë
const startEdit = (account) => {
    editingAccount.value = account.email;
    editForm.value.email = account.email;
    editForm.value.sessionKey = ""; // Ê∏ÖÁ©∫ÔºåËÆ©Áî®Êà∑ËæìÂÖ•Êñ∞ÁöÑÂÆåÊï¥SK
};

// ‰øùÂ≠òÁºñËæë
const saveEdit = async (originalEmail) => {
    try {
        editLoading.value = true;
        await claudePoolApi.updateAccount(
            originalEmail,
            editForm.value.email,
            editForm.value.sessionKey
        );
        ElMessage.success("Ë¥¶Êà∑Êõ¥Êñ∞ÊàêÂäü");
        cancelEdit();
        emit("refresh");
    } catch (error) {
        console.error("Êõ¥Êñ∞Ë¥¶Êà∑Â§±Ë¥•:", error);
        ElMessage.error("Êõ¥Êñ∞Ë¥¶Êà∑Â§±Ë¥•");
    } finally {
        editLoading.value = false;
    }
};

// ÂèñÊ∂àÁºñËæë
const cancelEdit = () => {
    editingAccount.value = null;
    editForm.value.email = "";
    editForm.value.sessionKey = "";
};

// ÁõëÂê¨Ë¥¶Êà∑ÂàóË°®ÂèòÂåñÔºåÊ∏ÖÁ©∫ÈÄâÊã©Âπ∂Âä†ËΩΩÁä∂ÊÄÅ
watch(
    () => props.accountList,
    (newAccountList) => {
        selectedAccounts.value = [];
        // ÂΩìË¥¶Êà∑ÂàóË°®ÂèòÂåñÊó∂ÔºåËá™Âä®Âä†ËΩΩÁä∂ÊÄÅÔºà‰ªÖÂú®Âç°ÁâáËßÜÂõæÊ®°Âºè‰∏ãÔºâ
        if (
            viewMode.value === "cards" &&
            newAccountList &&
            newAccountList.length > 0
        ) {
            refreshAllStatus();
        }
    }
);

// ÁõëÂê¨ËßÜÂõæÊ®°ÂºèÂèòÂåñÔºåÂàáÊç¢Âà∞Âç°ÁâáËßÜÂõæÊó∂Âä†ËΩΩÁä∂ÊÄÅ
watch(
    () => viewMode.value,
    (newMode) => {
        if (
            newMode === "cards" &&
            props.accountList &&
            props.accountList.length > 0
        ) {
            refreshAllStatus();
        }
    }
);

// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂ÔºåÂ¶ÇÊûúÊòØÂç°ÁâáËßÜÂõæ‰∏îÊúâË¥¶Êà∑Êï∞ÊçÆÔºåÂàôÂä†ËΩΩÁä∂ÊÄÅ
onMounted(() => {
    if (
        viewMode.value === "cards" &&
        props.accountList &&
        props.accountList.length > 0
    ) {
        refreshAllStatus();
    }
});
</script>

<style scoped>
.account-management {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Ê∑ªÂä†Áî®Êà∑Âå∫Âüü */
.add-user-section {
    margin-bottom: 20px;
}

.add-user-form {
    padding: 10px 0;
}

.add-button {
    width: 100%;
}

/* ÊêúÁ¥¢Âå∫Âüü */
.search-section {
    margin-bottom: 20px;
}

.search-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
}

.search-input {
    flex: 1;
    max-width: 400px;
}

.action-buttons {
    display: flex;
    gap: 10px;
}

/* Ë¥¶Êà∑ÂàóË°®Âå∫Âüü */
.account-list-section {
    flex: 1;
}

.account-table {
    margin-top: 10px;
}

.action-buttons-cell {
    display: flex;
    gap: 5px;
}

.email-text {
    font-family: monospace;
    color: #303133;
}

.sk-preview {
    font-family: monospace;
    color: #909399;
    font-size: 12px;
}

.loading-message {
    padding: 40px;
    text-align: center;
}

.empty-state {
    padding: 40px;
    text-align: center;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 16px;
    font-weight: 600;
    color: #303133;
}

.view-mode-indicator {
    font-size: 12px;
    color: #909399;
    font-weight: normal;
}

/* ÊêúÁ¥¢Ê†èÊ†∑Âºè */
.search-bar {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
}

.search-input {
    flex: 1;
    min-width: 200px;
}

.view-mode-switch {
    flex-shrink: 0;
}

.action-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

/* Âç°ÁâáËßÜÂõæÊ†∑Âºè */
.cards-view {
    margin-top: 16px;
}

.account-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
    padding: 8px 0;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
    .search-bar {
        flex-direction: column;
        align-items: stretch;
    }

    .view-mode-switch {
        order: -1;
    }

    .account-cards-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 1200px) {
    .account-cards-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
}

/* ÂÖ®Â±ÄÊ†∑Âºè - ‰∏é‰ª™Ë°®Êùø‰øùÊåÅ‰∏ÄËá¥ */
:deep(.el-card) {
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: none;
}

:deep(.el-card__header) {
    background: #fafafa;
    border-bottom: 1px solid #f0f0f0;
    padding: 15px 20px;
}

:deep(.el-card__body) {
    padding: 20px;
}

:deep(.el-table) {
    border-radius: 8px;
    overflow: hidden;
}

:deep(.el-table th) {
    background: #fafafa;
    color: #303133;
    font-weight: 600;
}
</style>
